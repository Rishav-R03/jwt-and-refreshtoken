<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>JWT Spring Boot Client</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        body {
            background-color: #f8f9fa;
            padding-top: 50px;
        }

        .auth-card {
            max-width: 400px;
            margin: auto;
        }

        .hidden {
            display: none;
        }
    </style>
</head>

<body>

    <div class="container">
        <div id="auth-section" class="card auth-card shadow-sm p-4">
            <h3 class="text-center mb-4" id="form-title">Login</h3>
            <div class="mb-3">
                <label class="form-label">Username</label>
                <input type="text" id="username" class="form-control" placeholder="Enter username">
            </div>
            <div class="mb-3">
                <label class="form-label">Password</label>
                <input type="password" id="password" class="form-control" placeholder="Enter password">
            </div>
            <button class="btn btn-primary w-100 mb-2" onclick="handleAuth()">Submit</button>
            <p class="text-center">
                <small><a href="#" onclick="toggleAuthMode()" id="toggle-link">Need an account? Signup</a></small>
            </p>
        </div>

        <div id="dashboard-section" class="hidden text-center">
            <h2>Welcome to the Secured World</h2>
            <p class="text-muted">You are successfully logged in.</p>
            <div class="mt-4">
                <button class="btn btn-info" onclick="fetchData('/api/public/landing')">Test Public API</button>
                <button class="btn btn-warning" onclick="fetchData('/api/user/dashboard')">Test Secured API</button>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </div>
            <div id="api-response" class="mt-4 alert alert-secondary mx-auto" style="max-width: 600px;">
                API responses will appear here...
            </div>
        </div>
    </div>

    <script>
        const BASE_URL = 'http://localhost:5000'; // Change to your Spring Boot port
        let isLoginMode = true;

        function toggleAuthMode() {
            isLoginMode = !isLoginMode;
            document.getElementById('form-title').innerText = isLoginMode ? 'Login' : 'Signup';
            document.getElementById('toggle-link').innerText = isLoginMode ? 'Need an account? Signup' : 'Have an account? Login';
        }

        // --- AUTHENTICATION ---
        async function handleAuth() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const endpoint = isLoginMode ? '/api/auth/login' : '/api/auth/signup';

            try {
                const response = await fetch(BASE_URL + endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });

                const data = await response.json();

                if (response.ok) {
                    // Save tokens to localStorage
                    localStorage.setItem('accessToken', data.accessToken);
                    localStorage.setItem('refreshToken', data.refreshToken);
                    showDashboard();
                } else {
                    alert("Auth Failed: " + (data.message || "Invalid Credentials"));
                }
            } catch (error) {
                console.error("Error:", error);
            }
        }

        // --- AUTHORIZED API CALLS ---
        async function fetchData(endpoint) {
            const token = localStorage.getItem('accessToken');
            const responseDiv = document.getElementById('api-response');

            try {
                const response = await fetch(BASE_URL + endpoint, {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });

                if (response.status === 401 || response.status === 403) {
                    // If unauthorized, attempt to refresh token
                    const refreshed = await attemptTokenRefresh();
                    if (refreshed) {
                        return fetchData(endpoint); // Retry the call
                    } else {
                        logout();
                        return;
                    }
                }

                const text = await response.text();
                responseDiv.className = "mt-4 alert alert-success";
                responseDiv.innerText = text;
            } catch (error) {
                responseDiv.className = "mt-4 alert alert-danger";
                responseDiv.innerText = "Error fetching data.";
            }
        }

        // --- REFRESH TOKEN LOGIC ---
        async function attemptTokenRefresh() {
            const refreshToken = localStorage.getItem('refreshToken');
            if (!refreshToken) return false;

            try {
                const response = await fetch(BASE_URL + '/api/auth/refresh', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ refreshToken })
                });

                if (response.ok) {
                    const data = await response.json();
                    localStorage.setItem('accessToken', data.accessToken);
                    return true;
                }
            } catch (e) {
                console.error("Refresh failed", e);
            }
            return false;
        }

        // --- UI HELPERS ---
        function showDashboard() {
            document.getElementById('auth-section').classList.add('hidden');
            document.getElementById('dashboard-section').classList.remove('hidden');
        }

        function logout() {
            localStorage.clear();
            location.reload();
        }

        // Check if already logged in on page load
        window.onload = () => {
            if (localStorage.getItem('accessToken')) showDashboard();
        };
    </script>
</body>

</html>